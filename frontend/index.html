<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Socious Translator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', 'Helvetica Neue', sans-serif;
    }
  </style>
</head>
<body class="bg-[#111112] text-white min-h-screen flex flex-col items-center justify-center p-6 space-y-10">
  <h1 class="text-5xl font-bold tracking-tight text-center">Socious Translator</h1>

  <!-- Controls -->
  <div class="w-full max-w-2xl bg-[#1A1A1C] rounded-lg p-6 shadow-lg space-y-6 flex flex-col items-center">
    <label class="block text-base font-medium">Translation Direction</label>
    <select id="direction" class="w-full max-w-md bg-[#2A2A2E] text-white border border-gray-700 rounded px-4 py-2 focus:outline-none text-center">
      <option value="en-ja">English → Japanese</option>
      <option value="ja-en">Japanese → English</option>
    </select>

    <div class="flex gap-4 mt-4">
      <button id="startBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-6 py-2 rounded transition-all">Start Recording</button>
      <button id="stopBtn" disabled class="bg-gray-500 text-white font-semibold px-6 py-2 rounded opacity-50 cursor-not-allowed">Stop Recording</button>
    </div>
  </div>

  <!-- Display -->
  <div id="output" class="w-full max-w-6xl bg-[#1A1A1C] rounded-lg px-10 py-20 shadow-xl text-6xl font-semibold text-center leading-tight tracking-wide min-h-[320px] flex items-center justify-center">
    <!-- Translations appear here -->
  </div>

  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const output = document.getElementById("output");
    const directionSelect = document.getElementById("direction");

    let stream = null;
    let socket = null;
    let mediaRecorder = null;
    let recordingActive = false;
    let activeLine = null;

    directionSelect.onchange = () => stopRecording();

    async function startChunkRecorder() {
      return new Promise((resolve) => {
        mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });

        mediaRecorder.ondataavailable = async (e) => {
          if (e.data && e.data.size > 0 && socket?.readyState === WebSocket.OPEN) {
            const buffer = await e.data.arrayBuffer();
            socket.send(buffer);
          }
          resolve();
        };

        mediaRecorder.start();

        setTimeout(() => {
          if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
        }, 1800); // shorter chunks
      });
    }

    async function loopRecorder() {
      while (recordingActive) {
        await startChunkRecorder(); // no extra delay
      }
    }

    startBtn.onclick = async () => {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true }); // get mic early

      socket = new WebSocket("ws://34.69.242.211:8000/ws");

      socket.onopen = () => {
        socket.send(JSON.stringify({ direction: directionSelect.value }));
        recordingActive = true;
        loopRecorder();

        startBtn.disabled = true;
        startBtn.classList.add("opacity-50", "cursor-not-allowed");
        stopBtn.disabled = false;
        stopBtn.classList.remove("opacity-50", "cursor-not-allowed");
      };

      socket.onmessage = (event) => {
        const data = event.data;

        if (data.startsWith("[STREAM]")) {
          const text = data.replace("[STREAM]", "");
          if (!activeLine) {
            activeLine = document.createElement("div");
            activeLine.className = "text-gray-300 italic";
            output.innerHTML = "";
            output.appendChild(activeLine);
          }
          requestAnimationFrame(() => {
            activeLine.textContent = text + " ▌";
          });
        } else if (data.startsWith("[DONE]")) {
          const finalText = data.replace("[DONE]", "");
          if (finalText) {
            requestAnimationFrame(() => {
              activeLine.textContent = finalText;
              activeLine.classList.remove("italic", "text-gray-300");
              activeLine.classList.add("text-white");
              activeLine = null;
            });
          }
        }
      };
    };

    function stopRecording() {
      recordingActive = false;
      if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
      if (stream) stream.getTracks().forEach(track => track.stop());
      if (socket && socket.readyState === WebSocket.OPEN) socket.close();

      startBtn.disabled = false;
      startBtn.classList.remove("opacity-50", "cursor-not-allowed");
      stopBtn.disabled = true;
      stopBtn.classList.add("opacity-50", "cursor-not-allowed");
    }

    stopBtn.onclick = stopRecording;
  </script>
</body>
</html>
